<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title></title>
  <link rel="shortcut Icon" type="image/x-icon" href="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- core -->
  <script src="/static/core/jquery-3.5.1/jquery-3.5.1.min.js"></script>
  <link href="/static/core/bootstrap-5.1.2/css/bootstrap.min.css" rel="stylesheet">
  <script src="/static/core/bootstrap-5.1.2/js/bootstrap.bundle.min.js"></script>
  
  <!-- plugins -->
  <script src="/static/plugins/vue-2.6.12/vue.js"></script>
  <link href="/static/plugins/fontawesome-free-5.15.1-web/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.9.22/interact.min.js"></script>
  <!-- <link href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css" rel="stylesheet">
  <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script> -->

  <!-- main -->
  <link href="/static/common/css/emmet.css" rel="stylesheet">
  <link href="/static/common/css/main.css" rel="stylesheet">
  <script src="/static/common/js/main.js"></script>
</head>
<body>
  <div id="wrap">
    <header>
        <script>$.get('include/header.html', (res)=>{ $('header')[0].outerHTML=res } )</script>
    </header>

    <main id="main">
      <div id="dragContainer" class="pos-f loc-full">
        <div id="BG-drag" class="js-draggable" :data-id="bg.view.id" data-role="bg" 
          :data-x="bg.view.x" :data-y="bg.view.y"
          :style="`transform: translate(${bg.view.x}px,${bg.view.y}px);`">

          <img id="BG-img" :src="bg.view.src" @load="init_BG()"
            :style="`
              width: ${bg.view.fit_w * bg.scaleRange.val}px; 
              height: ${bg.view.fit_h * bg.scaleRange.val}px;
          `">

          <div id="paint-ruler" class="bg-grid-line pos-a loc-full" :style="`background-size: ${100 * paintScale}px ${100 * paintScale}px;`"></div>

          <div id="paint-dragBox" class="pos-a loc-full">
            <img v-for="(item,idx) in paint.add" class="js-draggable" :data-id="item.id" data-role="paint"
              :data-x="item.x" :data-y="item.y" :src="item.src"
              :style="`
                width: ${item.cm_w * paintScale}px; 
                height: ${item.cm_h * paintScale}px; 
                transform: translate(${item.x}px, ${item.y}px)
            `">
          </div>
        </div>
      </div>
  
      <div id="botMenu" class="pos-f loc-2 w-100">
        <div class="pos-a loc-t" style="top: -120px;">
          <div class="d-flex flex-column container-xl py-2" style="background-color: rgba(255,255,255,0.5)">
            <div class="text-center fw-bold">比例尺 (一格為1公尺)</div>
            <div class="d-flex">
              <i id="ruler-scaleDown" class="fa fa-minus px-1"></i>
              <input id="ruler-scaleRange" type="range" :min="paint.scaleRange.min" :max="paint.scaleRange.max" step="0.001" class="w-100" v-model.number="paint.scaleRange.val" @input="scale_after_center_paint()">
              <i id="ruler-scaleUp" class="fa fa-plus px-1"></i>
            </div>
          </div>
        </div>
        <div class="pos-a loc-t" style="top: -60px;">
          <div class="d-flex flex-column container-xl py-2" style="background-color: rgba(255,255,255,0.5)">
            <div class="text-center fw-bold">整體大小</div>
            <div class="d-flex">
              <i id="bg-scaleDown" class="fa fa-minus px-1"></i>
              <input id="bg-scaleRange" type="range" :min="bg.scaleRange.min" :max="bg.scaleRange.max" step="0.01" class="w-100" v-model.number="bg.scaleRange.val" @input="scale_after_center_BG()">
              <i id="bg-scaleUp" class="fa fa-plus px-1"></i>
            </div>
          </div>
        </div>

        <div id="botMenu-content" class="bg-white" style="min-height: 230px;">
          <nav id="botMenu-header">
            <div class="nav nav-tabs" role="tablist">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#menu-paint" type="button" role="tab">畫作</button>
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#menu-bg" type="button" role="tab">背景</button>
            </div>
          </nav>
          <div id="botMenu-body" class="tab-content">

            <div id="menu-paint" class="tab-pane fade show active" role="tabpanel">
              <div class="d-flex">
                <div v-for="(item,idx) of paint.list" v-show="item.show" class="imgBox img-full img-contain" :style="`background-image: url(${item.src})`">
                  <button class="btn btn-primary fas fa-plus pos-a loc-9 js-addBtn" @click="append_Paint( paint.list, idx )"></button>
                </div>
              </div>
            </div>

            <div id="menu-bg" class="tab-pane fade" role="tabpanel">
              <div class="mb-2">選擇背景: <input id="file" type="file" accept="image/*" @change="upload_BG"></div>
              <label> <input type="radio" v-model="bg.mode" value="contain" @change="init_BG()"> 全螢幕 contain </label>
              <label> <input type="radio" v-model="bg.mode" value="cover" @change="init_BG()"> 填滿 cover </label>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      var vm = new Vue({
        el: '#main',
        mounted() {
          let V = this
          V.init_BG()
          $(window).on('resize',()=>{
            V.init_BG()
          })
          
          interact('.js-draggable').draggable({
            listeners: {
              start(event) {
              },
              move(event) {
                var $target = $(event.target)
                let x = ( (+$target.attr('data-x') ) || 0) + event.dx
                let y = ( (+$target.attr('data-y') ) || 0) + event.dy

                $target.attr('data-x', x)
                $target.attr('data-y', y)
                $target.css('transform', 'translate('+x+'px, '+y+'px)')
              },
              end(event) {
                var $target = $(event.target)
                var id = $target.attr('data-id')
                var role = $target.attr('data-role')

                if ( role === 'bg' ){
                  let BGv = vm.$data.bg.view
                  if ( BGv.id == id ){
                    BGv.x = +$target.attr('data-x')
                    BGv.y = +$target.attr('data-y')
                  }
                }
                if ( role === 'paint' ){
                  vm.$data.paint.add.forEach( (ele, idx, arr)=>{
                    if ( ele.id == id ){
                      arr[idx].x = +$target.attr('data-x')
                      arr[idx].y = +$target.attr('data-y')
                    }
                  })
                }
              }
            },
            inertia: true,
            modifiers: [
              interact.modifiers.restrictRect({
                restriction: $('#dragContainer')[0],
              })
            ],
          })

        },
        data: {
          bg: {
            mode: 'cover',
            scaleRange: {
              min: 0.2,
              max: 5,
              val: 1,
              oldVal: 1,
            },
            view: { id: 1005, cm_w: 100, cm_h: 0, nat_w: 0, nat_h: 0, ratio: 0, fit_w: 0, fit_h: 0, fit_s: 0, src: 'https://storage.googleapis.com/opinion-cms-cwg-tw/article/202103/article-6052f9b074f33.jpg', x: 0, y: 0, },
            list: [
              { id: 1004, nat_w: 0, nat_h: 0, ratio: 0, fit_w: 0, fit_h: 0, fit_s: 0, src: 'https://picsum.photos/1600/900', x: 0, y: 0, },
            ],
          },
          paint: {
            scaleRange: {
              min: 0.05,
              max: 1,
              val: 0.10,
              oldVal: 1,
            },
            add: [],
            list: [
              { id: 1001, cm_w: 60, cm_h: 40, src: 'https://picsum.photos/600/400', x: 0, y: 0, show: true },
              { id: 1002, cm_w: 90, cm_h: 120, src: 'https://picsum.photos/300/400', x: 0, y: 0, show: true },
              { id: 1003, cm_w: 100, cm_h: 100, src: 'https://picsum.photos/500/500', x: 0, y: 0, show: true },
            ],
          }
        },
        computed: {
          paintScale(){
            let V = this
            return V.paint.scaleRange.val * V.bg.view.fit_s * V.bg.scaleRange.val
          },
        },
        methods: {
          addItem(arr, obj) {
            arr.push(obj)
          },
          delItem(arr, idx) {
            arr.splice(idx, 1)
          },
          upload_BG(evt){
            let target = evt.target
            if (target.files && target.files[0]) {
              var reader = new FileReader()
              reader.readAsDataURL(target.files[0])
              reader.onload = function() {
                let base64 = this.result
                $('#BG-img').attr('src', base64)
              }
            }
          },
          append_Paint(arr,idx){
            let V = this
            arr[idx].show = false
            arr[idx].x = V.bg.view.fit_w/2 - arr[idx].cm_w/2
            arr[idx].y = V.bg.view.fit_h/2 - arr[idx].cm_h/2 - $('#botMenu-content').height()/2
            V.addItem( V.paint.add, arr[idx] )
          },

          init_BG(){
            let V = this
                V.bg.scaleRange.val = 1
            
            let Img = $('#BG-img')[0]
            let BG = V.bg.view
                BG.nat_w = Img.naturalWidth
                BG.nat_h = Img.naturalHeight
                BG.ratio = BG.nat_w / BG.nat_h // 圖片長寬比
                BG.cm_h = 100 * BG.ratio // 寬100公分 / 高x公分

            let w_ratio = window.innerWidth / window.innerHeight // 螢幕長寬比
            let modeBool = V.bg.mode === 'cover' ? BG.ratio > w_ratio : BG.ratio < w_ratio

            if ( modeBool ){ // 圖片寬/高比 > 螢幕 (cover)
              BG.fit_h = window.innerHeight
              BG.fit_w = window.innerHeight * BG.ratio
              BG.x = -( BG.fit_w - window.innerWidth ) / 2
              BG.y = 0
            } else {
              BG.fit_w = window.innerWidth
              BG.fit_h = window.innerWidth / BG.ratio
              BG.x = 0
              BG.y = -( BG.fit_h - window.innerHeight ) / 2
            }
            BG.fit_s = BG.fit_w / 100 // 以100公分為基礎
            // BG.fit_s = BG.fit_w / Img.naturalWidth
          },

          scale_after_center_BG(){
            let V = this
            let { view:BGv, scaleRange:BGs } = V.bg
            let oldScale = +BGs.oldVal
            let newScale = +BGs.val

            var $target = $(event.target)

            let x = ( BGv.fit_w*newScale - BGv.fit_w*oldScale ) / 2
            let y = ( BGv.fit_h*newScale - BGv.fit_h*oldScale ) / 2
            BGv.x -= x
            BGv.y -= y
            
            let amp = newScale / oldScale
            V.paint.add.forEach( item => {
              item.x = item.x * amp
              item.y = item.y * amp
            }) 
            
            BGs.oldVal = newScale
          },

          scale_after_center_paint(){
            let V = this
            let oldScale = +V.paint.scaleRange.oldVal
            let newScale = +V.paint.scaleRange.val
            let paintScale = V.paint.scaleRange.val * V.bg.view.fit_s * (newScale - oldScale)

            // 待調整
            V.paint.add.forEach( item => {
              item.x -= item.cm_w * paintScale / 2
              item.y -= item.cm_h * paintScale / 2
            })

            V.paint.scaleRange.oldVal = newScale
          },
        }
      })

      function getTransform( target ){
        var style = window.getComputedStyle( target )
        var matrix = new WebKitCSSMatrix(style.transform)
        var {a,b,c,d,e,f,m11,m12,m13,m14,m21,m22,m23,m24,m31,m32,m33,m34,m41,m42,m43,m44} = matrix
        return { x: m41, y: m42 }
      }

      function ImgDraggable(){
        
      }
      
      function ImgGesturable(){
        interact('#BG-img')
          .gesturable({
            listeners: {
              start (event) {
              },
              move (event) {
                var newScale = BG.evt_s * event.scale

                $(event.target).css({ 
                  width: BG.fit_w * newScale, 
                  height: BG.fit_h * newScale 
                })

                dragMoveListener(event)
              },
              end (event) {
                BG.evt_s = BG.evt_s * event.scale
              }
            },
            // inertia: true
          })
          .draggable({
            listeners: { move: dragMoveListener },
            // inertia: true
          })
      }

      function ImgResizable(){
        interact('.js-resizable')
          .resizable({
            // resize from all edges and corners
            edges: { left: true, right: true, bottom: true, top: true },

            listeners: {
              move (event) {
                var target = event.target
                var x = (parseFloat(target.getAttribute('data-x')) || 0)
                var y = (parseFloat(target.getAttribute('data-y')) || 0)

                // update the element's style
                target.style.width = event.rect.width + 'px'
                target.style.height = event.rect.height + 'px'

                // translate when resizing from top or left edges
                x += event.deltaRect.left
                y += event.deltaRect.top

                target.style.transform = 'translate(' + x + 'px,' + y + 'px)'
                
                target.setAttribute('data-x', x)
                target.setAttribute('data-y', y)
              }
            },
            modifiers: [
              interact.modifiers.aspectRatio({
                ratio: 16/9,
                // modifiers: [
                //   interact.modifiers.restrictEdges({ outer: 'parent' })
                // ]
              }),

              // keep the edges inside the parent
              // interact.modifiers.restrictEdges({
              //   outer: 'parent'
              // }),

              // minimum size
              interact.modifiers.restrictSize({
                min: { width: 100, height: 100 }
              })
            ],

            inertia: true
          })
          .draggable({
            listeners: { move: dragMoveListener },
            inertia: true,
            // modifiers: [
            //   interact.modifiers.restrictRect({
            //     restriction: 'parent',
            //     endOnly: true
            //   })
            // ]
          })
      }

    </script>
  </div>
</body>
</html>